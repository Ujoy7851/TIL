## 실행 컨텍스트
실행 컨텍스트(Execution Context)는 자바스크립트의 핵심적인 동작 원리로, 이것을 이해하면 클로저, 호이스팅과 같은 필수 개념을 이해할 수 있습니다.

실행 컨텍스트는 코드가 실행되기 위해 필요한 환경을 말합니다. 자바스크립트 엔진은 코드를 실행하기 위해 변수, 함수의 선언, 스코프, this와 같은 정보를 필요로 하는데 이를 물리적 객체의 형태로 표현한 것이 실행 컨텍스트입니다.

실행 컨텍스트는 다음과 같은 원리로 동작합니다. 일단 코드가 처음 실행되면 실행 컨텍스트 스택이 생성됩니다. 전역 코드로 컨트롤이 진입하면서 전역 컨텍스트가 생성되고 실행 컨텍스트 스택에 쌓입니다. 전역 컨텍스트는 페이지 또는 브라우저가 종료될 때까지 유지됩니다. 이때 함수를 호출하면 해당 함수의 실행 컨텍스트가 생성되면서 실행 컨텍스트 스택에 쌓입니다. 함수의 실행이 끝나면 해당 함수의 실행 컨텍스트가 사라지고 직전의 실행 컨텍스트에 컨트롤이 반환됩니다.

### 실행 컨텍스트의 3가지 객체
실행 컨텍스트는 물리적으로 객체의 형태를 가지며 다음의 3가지 프로퍼티를 가집니다.

**변수 객체 (Variable Object)**

변수 객체는 아래의 정보를 담고 있는 객체입니다.
- 변수
- 매개변수, 인수 정보
- 함수 선언 (함수 표현식 제외)

변수 객체는 코드 실행시 엔진에 의해 참조되며 코드에서는 접근할 수 없습니다. 변수 객체는 전역 컨텍스트와 함수 컨텍스트에서 서로 다른 객체를 가리킵니다. 전역 컨텍스트의 경우에는 매개변수가 없으며 전역 변수와 전역 함수를 프로퍼티로 소유하는 **전역 객체** (Global Object)를 가리킵니다. 함수 컨텍스트의 경우에는 **활성 객체**(Activation Object)를 가리키는데 이는 내부 함수의 선언과 지역 변수, 그리고 매개 변수에 대한 정보를 담고 있습니다.

**스코프 체인 (Scope Chain)**
	
스코프 체인은 해당 지역에서 참조할 수 있는 변수, 함수 선언 등의 정보를 담고 있는 전역 객체 또는 활성 객체의 리스트를 가리킵니다. 현재 실행 컨텍스트의 활성 객체부터 순차적으로 상위 컨텍스트의 활성 객체를 가리키며 마지막으로는 전역 객체를 담고 있습니다. 함수 실행 중 변수를 만나면 엔진은 스코프 체인의 리스트가 가리키는 첫번째 활성 객체부터 순서대로 검색을 이어나가게 됩니다. 마지막으로 전역 객체에서도 변수를 찾지 못한 경우에는 Reference 에러를 발생시킵니다. 스코프 체인은 함수의 프로퍼티인 [[Scope]]으로 참조할 수 있습니다.

**this**

this 프로퍼티에는 this 값이 할당됩니다. 일반적으로 window가 할당되지만 함수 호출 패턴에 따라 다른 값이 할당될 수도 있습니다.
	
### 실행 컨텍스트 생성 과정
아래 예제 코드를 통해 어떤 과정을 따라 실행 컨텍스트가 생성되는지 알아봅시다.
```javascript
var x = 'xxx';

function foo () {
  var y = 'yyy';

  function bar () {
    var z = 'zzz';
    console.log(x + y + z);
  }
  bar();
}

foo();
```

**전역 코드에 진입**

컨트롤이 실행 컨텍스트에 진입하기 전에 전역 객체가 생성됩니다. 초기 상태의 전역 객체에는 빌트인 객체(Math, String, Array 등)와 DOM, BOM이 설정되어 있습니다. 이후 전역 코드로 컨트롤이 진입하면 전역 컨텍스트가 생성되고 실행 컨텍스트 스택에 쌓입니다. 그리고 실행 컨텍스트를 바탕으로 다음 처리가 실행됩니다.
- 스코프 체인의 생성, 초기화: 스코프 체인의 리스트에 전역 객체의 레퍼런스가 포함됩니다.
- 변수 객체화 실행: 변수 객체화는 변수 객체에 프로퍼티와 값을 추가하는 것을 의미합니다. 전역 코드의 경우 전역 객체를 가리킵니다. 변수 객체화는 아래와 같은 순서로 변수 객체에 값을 추가합니다.
	- 매개변수가 프로퍼티로, 인수가 값을 설정됩니다.
	- 코드 내의 함수 선언(함수 표현식 제외)을 대상으로 함수명을 프로퍼티, 생성된 함수 객체를 값으로 설정합니다. -> 함수 호이스팅 / 생성된 함수 객체는 [[Scope]] 프로퍼티를 가지는데 이는 현재 실행 컨텍스트의 스코프 체인이 참조하고 있는 객체를 값으로 설정합니다. 함수의 [[Scope]] 프로퍼티는 외부 함수의 컨텍스트가 소멸해도 프로퍼티가 가리키는 외부 함수의 실행 환경은 소멸하지 않고 참조할 수 있습니다. -> 클로저
	- 코드 내의 변수 선언을 대상으로 변수명을 프로퍼티, undefined를 값으로 설정합니다. 이후 변수 할당문에 도달하면 비로소 값의 할당이 이루어집니다. (let, const로 변수를 선언한 경우 undefined로 초기화되지 않습니다.)-> 변수 호이스팅
- this에 값을 할당합니다. 전역 코드의 경우 this는 전역 객체를 가리킵니다.

전역 컨텍스트의 경우에는 변수 객체, 스코프 체인, this 값은 모두 전역 객체를 가리킵니다.
![](https://poiemaweb.com/img/ec_9.png)

**전역 코드의 실행**

전역 코드가 실행되면서 전역 변수 x에 'xxx'이 할당됩니다. 이때 현재 실행 컨텍스의 스코프 체인이 참조하고 있는 변수 객체를 순차적으로 검색하면서 변수명에 해당하는 프로퍼티가 발견되면 'xxx'값을 할당합니다.

다음으로 함수 foo가 실행되기 시작하면 새로운 함수 실행 컨텍스트가 생성됩니다. 전역 컨텍스트를 생성하는 것과 마친가지로 스코프 체인의 생성 및 초기화, 변수 객체화 실행, this 값 결정의 순서로 진행됩니다.
- 스코프 체인의 생성, 초기화: 활성 객체를 생성한 뒤 해당 레퍼런스를 스코프 체인의 선두에 설정합니다. 그 후 Caller(여기서는 전역 컨텍스트)의 스코프 체인이 참조하고 있는 객체가 스코프 체인에 push됩니다.
- 변수 객체화 실행: 앞선 과정에서 생성된 활성 객체를 변수 객체로 하여 변수 객체화가 진행됩니다.
- this 값 할당: 내부 함수의 경우 this는 전역 객체를 가리킵니다.

![](https://poiemaweb.com/img/ec_15.png)

**foo 함수의 실행**

함수 내부 코드가 실행되면서 전역 변수 x에 'xxx'이 할당됩니다. 이때 현재 실행 컨텍스의 스코프 체인이 참조하고 있는 변수 객체를 순차적으로 검색하면서 변수명에 해당하는 프로퍼티가 발견되면 'xxx'값을 할당합니다.

다음으로 함수 foo가 실행되기 시작하면 새로운 함수 실행 컨텍스트가 생성됩니다. 이 과정은 앞서 foo 함수의 실행 컨텍스트가 생성되는 과정과 동일합니다.

![](https://poiemaweb.com/img/ec_19.png)


### Reference
- https://poiemaweb.com/js-execution-context
- https://www.zerocho.com/category/JavaScript/post/5741d96d094da4986bc950a0